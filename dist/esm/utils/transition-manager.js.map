{"version":3,"sources":["../../../src/utils/transition-manager.js"],"names":["assert","LinearInterpolator","MapState","noop","TRANSITION_EVENTS","BREAK","SNAP_TO_END","IGNORE","DEFAULT_PROPS","transitionDuration","transitionEasing","t","transitionInterpolator","transitionInterruption","onTransitionStart","onTransitionInterrupt","onTransitionEnd","onViewportChange","onStateChange","DEFAULT_STATE","animation","propsInTransition","startProps","endProps","TransitionManager","props","state","_onTransitionFrame","bind","nextProps","transitionTriggered","currentProps","_shouldIgnoreViewportChange","isTransitionInProgress","_isTransitionInProgress","_isTransitionEnabled","Object","assign","interruption","_triggerTransition","_endTransition","Boolean","interpolator","arePropsEqual","_isUpdateDueToCurrentTransition","cancelAnimationFrame","initialProps","initializeProps","interactionState","inTransition","isZooming","zoom","isPanning","longitude","latitude","isRotating","bearing","pitch","duration","easing","startTime","Date","now","start","end","requestAnimationFrame","_updateViewport","currentTime","shouldEnd","viewport","interpolateProps","mapState","getViewportProps","defaultProps"],"mappings":"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","sourcesContent":["/* global requestAnimationFrame, cancelAnimationFrame */\nimport assert from './assert';\nimport {LinearInterpolator} from './transition';\nimport MapState from './map-state';\n\nconst noop = () => {};\n\nexport const TRANSITION_EVENTS = {\n  BREAK: 1,\n  SNAP_TO_END: 2,\n  IGNORE: 3\n};\n\nconst DEFAULT_PROPS = {\n  transitionDuration: 0,\n  transitionEasing: t => t,\n  transitionInterpolator: new LinearInterpolator(),\n  transitionInterruption: TRANSITION_EVENTS.BREAK,\n  onTransitionStart: noop,\n  onTransitionInterrupt: noop,\n  onTransitionEnd: noop,\n  onViewportChange: noop,\n  onStateChange: noop\n};\n\nconst DEFAULT_STATE = {\n  animation: null,\n  propsInTransition: null,\n  startProps: null,\n  endProps: null\n};\n\nexport default class TransitionManager {\n  constructor(props) {\n    this.props = props;\n    this.state = DEFAULT_STATE;\n\n    this._onTransitionFrame = this._onTransitionFrame.bind(this);\n  }\n\n  // Returns current transitioned viewport.\n  getViewportInTransition() {\n    return this.state.propsInTransition;\n  }\n\n  // Process the viewport change, either ignore or trigger a new transiton.\n  // Return true if a new transition is triggered, false otherwise.\n  processViewportChange(nextProps) {\n    let transitionTriggered = false;\n    const currentProps = this.props;\n    // Set this.props here as '_triggerTransition' calls '_updateViewport' that uses this.props.\n    this.props = nextProps;\n\n    if (!currentProps) {\n      return false;\n    }\n\n    // NOTE: Be cautious re-ordering statements in this function.\n    if (this._shouldIgnoreViewportChange(currentProps, nextProps)) {\n      return transitionTriggered;\n    }\n\n    const isTransitionInProgress = this._isTransitionInProgress();\n\n    if (this._isTransitionEnabled(nextProps)) {\n      const startProps = Object.assign({}, currentProps,\n        this.state.interruption === TRANSITION_EVENTS.SNAP_TO_END ?\n        this.state.endProps : this.state.propsInTransition\n      );\n\n      if (isTransitionInProgress) {\n        currentProps.onTransitionInterrupt();\n      }\n      nextProps.onTransitionStart();\n\n      this._triggerTransition(startProps, nextProps);\n\n      transitionTriggered = true;\n    } else if (isTransitionInProgress) {\n      currentProps.onTransitionInterrupt();\n      this._endTransition();\n    }\n\n    return transitionTriggered;\n  }\n\n  // Helper methods\n\n  _isTransitionInProgress() {\n    return Boolean(this.state.propsInTransition);\n  }\n\n  _isTransitionEnabled(props) {\n    return props.transitionDuration > 0 && Boolean(props.transitionInterpolator);\n  }\n\n  _isUpdateDueToCurrentTransition(props) {\n    if (this.state.propsInTransition) {\n      return this.state.interpolator.arePropsEqual(props, this.state.propsInTransition);\n    }\n    return false;\n  }\n\n  _shouldIgnoreViewportChange(currentProps, nextProps) {\n    if (this._isTransitionInProgress()) {\n      // Ignore update if it is requested to be ignored\n      return this.state.interruption === TRANSITION_EVENTS.IGNORE ||\n        // Ignore update if it is due to current active transition.\n        this._isUpdateDueToCurrentTransition(nextProps);\n    } else if (this._isTransitionEnabled(nextProps)) {\n      // Ignore if none of the viewport props changed.\n      return nextProps.transitionInterpolator.arePropsEqual(currentProps, nextProps);\n    }\n    return true;\n  }\n\n  _triggerTransition(startProps, endProps) {\n    assert(this._isTransitionEnabled(endProps), 'Transition is not enabled');\n\n    cancelAnimationFrame(this.state.animation);\n\n    const initialProps = endProps.transitionInterpolator.initializeProps(\n      startProps,\n      endProps\n    );\n\n    const interactionState = {\n      inTransition: true,\n      isZooming: startProps.zoom !== endProps.zoom,\n      isPanning: startProps.longitude !== endProps.longitude ||\n        startProps.latitude !== endProps.latitude,\n      isRotating: startProps.bearing !== endProps.bearing ||\n        startProps.pitch !== endProps.pitch\n    };\n\n    this.state = {\n      // Save current transition props\n      duration: endProps.transitionDuration,\n      easing: endProps.transitionEasing,\n      interpolator: endProps.transitionInterpolator,\n      interruption: endProps.transitionInterruption,\n\n      startTime: Date.now(),\n      startProps: initialProps.start,\n      endProps: initialProps.end,\n      animation: null,\n      propsInTransition: {},\n      interactionState\n    };\n\n    this._onTransitionFrame();\n    this.props.onStateChange(interactionState);\n  }\n\n  _onTransitionFrame() {\n    // _updateViewport() may cancel the animation\n    this.state.animation = requestAnimationFrame(this._onTransitionFrame);\n    this._updateViewport();\n  }\n\n  _endTransition() {\n    cancelAnimationFrame(this.state.animation);\n    this.state = DEFAULT_STATE;\n    this.props.onStateChange({\n      inTransition: false,\n      isZooming: false,\n      isPanning: false,\n      isRotating: false\n    });\n  }\n\n  _updateViewport() {\n    // NOTE: Be cautious re-ordering statements in this function.\n    const currentTime = Date.now();\n    const {startTime, duration, easing, interpolator, startProps, endProps} = this.state;\n\n    let shouldEnd = false;\n    let t = (currentTime - startTime) / duration;\n    if (t >= 1) {\n      t = 1;\n      shouldEnd = true;\n    }\n    t = easing(t);\n\n    const viewport = interpolator.interpolateProps(startProps, endProps, t);\n      // Normalize viewport props\n    const mapState = new MapState(Object.assign({}, this.props, viewport));\n    this.state.propsInTransition = mapState.getViewportProps();\n\n    this.props.onViewportChange(\n      this.state.propsInTransition,\n      this.state.interactionState,\n      this.props\n    );\n\n    if (shouldEnd) {\n      this._endTransition();\n      this.props.onTransitionEnd();\n    }\n  }\n}\n\nTransitionManager.defaultProps = DEFAULT_PROPS;\n"],"file":"transition-manager.js"}